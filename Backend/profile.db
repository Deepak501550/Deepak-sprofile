import sqlite3

# Initialize the database connection
conn = sqlite3.connect('profiles.db')
cursor = conn.cursor()

# Create table
cursor.execute('''CREATE TABLE IF NOT EXISTS user_profiles
                 (name TEXT, occupation TEXT, skills TEXT)''')

# Save profile function
def save_profile(name, occupation, skills):
    cursor.execute("INSERT INTO user_profiles (name, occupation, skills) VALUES (?, ?, ?)",
                   (name, occupation, skills))
    conn.commit()

@app.route('/api/chat', methods=['POST'])
def chat():
    # Store profile in DB as well
    user_message = request.json.get('message')
    
    if 'name' not in profile:
        profile['name'] = user_message
        reply = f"Nice to meet you, {profile['name']}! What is your occupation?"
    elif 'occupation' not in profile:
        profile['occupation'] = user_message
        reply = f"Great! You're a {profile['occupation']}. What are your key skills?"
    elif 'skills' not in profile:
        profile['skills'] = user_message
        save_profile(profile['name'], profile['occupation'], profile['skills'])
        reply = f"Profile generated and saved: Name: {profile['name']}, Occupation: {profile['occupation']}, Skills: {profile['skills']}"

    return jsonify({'reply': reply})
